# Tilemap Editor 操作与功能说明（持续更新）

更新时间：2026-01-22

本文目标：
- 记录当前 `tilemap_editor` 已实现的功能与操作方式（键鼠/快捷键/右键菜单）。
- 作为后续迭代的“基准文档”，每加一项功能就补一条。

> 说明：下文默认右侧为画布（地图网格），左侧为 tileset/palette 面板。

---

## 1. 视图操作（相机）

- 缩放：鼠标滚轮（在右侧画布区域）
- 平移：
  - 中键按住拖动
  - 或 `Space` + 左键按住拖动

> 注意：按住 `Space` 时，绘制/框选/填充等会被抑制，避免误操作。

---

## 2. 工具切换

工具概览（当前实现）：
- Pencil（铅笔）
- Eraser（橡皮）
- Rect（矩形填充）
- Fill（油漆桶 Flood Fill）
- Select（选择）
- Eyedropper（吸管）
- Paste（粘贴）

快捷键（数字键）：
- `1`：Pencil
- `2`：Rect
- `3`：Fill
- `4`：Select
- `5`：Paste（“锁定粘贴模式”，可连续多次粘贴）
- `6`：Eraser

临时吸管：
- 按住 `I`：临时切到吸管（松开恢复到原工具）

---

## 3. 绘制与擦除

### 3.1 Pencil（铅笔）
- 左键按住：在鼠标经过的格子上绘制“当前选中 tile”（支持连续拖拽）

### 3.2 Eraser（橡皮）
- 左键按住：擦除（把格子置空）

> 右键不再用于擦除：右键统一保留给“右键菜单”。

---

## 4. 矩形与填充

### 4.1 Rect（矩形填充）
- 左键按住拖拽：框出矩形区域
- 松开：一次性写入
- `Shift` + 左键拖拽：矩形擦除（写入 None）

### 4.2 Fill（油漆桶 Flood Fill）
- 左键单击某格：对与该格“同类 tile”的连通区域进行 4 邻接填充
- `Shift` + 左键单击：填充擦除（写入 None）

---

## 5. 选择（框选）与选区内容移动

### 5.1 进入选区/框选
- 方式 A：切到 Select（`4`），左键拖拽框选
- 方式 B（试验版，更安全）：按住 `Alt` + 左键拖拽，可从任意工具进入框选；开始拖拽时会自动切到 Select

### 5.2 选择框显示
- 选择框会在画布上以黄色边框显示

### 5.3 选区内容移动（鼠标拖拽）
在 Select 工具下：
- 在选区内部 **左键按住拖动**：移动选区内的内容
  - 拖拽中会显示半透明“幽灵预览”
  - 松开鼠标后一次性提交为一个 Undo 命令
- `Ctrl` + 在选区内左键拖动：复制移动（原区域保留，同时在新位置写入一份）

> 注意：`Alt` 被保留给“框选入口”，所以拖拽移动时不使用 Alt。

---

## 6. 复制/剪切/粘贴（Stamp 工作流）

### 6.1 复制 / 剪切
- `Ctrl + C`：复制当前选区到剪贴板
- `Ctrl + X`：剪切当前选区到剪贴板（并清空原区域）

### 6.2 粘贴
进入粘贴模式有两种方式：
- `Ctrl + V`：进入“临时粘贴”（贴一次后自动回到原工具）
- `5`：进入“锁定粘贴”（可连续多次粘贴，直到退出）

粘贴落地：
- 粘贴模式下，左键单击：把剪贴板内容贴到鼠标所在格子（作为左上角）

退出粘贴：
- `Esc`：退出粘贴

---

## 7. 旋转/翻转/重置（Q/E/H/V）

Q/E/H/V 的“作用对象优先级”（从高到低）：
1) 如果当前工具是 Paste：修改粘贴变换（会影响粘贴预览与落地结果）
2) 否则如果当前工具是 Select 且存在选区：对“选区内容”做旋转/翻转/重置
3) 否则如果鼠标指向的格子里有 tile：对“单格 tile”做旋转/翻转/重置
4) 否则如果剪贴板非空：修改“预设粘贴变换”（用于先旋转，再 `Ctrl+V`）

快捷键：
- `Q`：逆时针旋转 90°
- `E`：顺时针旋转 90°
- `H`：水平翻转
- `V`：垂直翻转

右键菜单：
- 在画布上右键可打开菜单，菜单项会根据“鼠标下是否有 tile / 是否有选区 / 剪贴板是否为空”自动启用/禁用。

---

## 8. 撤销/重做

- `Ctrl + Z`：Undo
- `Ctrl + Y` 或 `Ctrl + Shift + Z`：Redo

说明：
- Pencil 连续拖拽会被合并成一个 stroke 命令（松开鼠标一次提交）。
- Rect/Fill/粘贴/选区移动 也都会各自提交一个命令。

---

## 9. 地图整体移位（Shift Map）

- `Ctrl + 方向键`：整体平移一格
- 模式：
  - Blank：空出来的格子填 None
  - Wrap：环绕（从另一边“卷”回来）

---

## 10. 选择辅助

- `Ctrl + A`：全选
- `Ctrl + D`：取消选择

清除：
- `Delete` / `Backspace`：清空选区内容（保持选区）

---

## 11. 保存/读取

- `S`：保存
- `L`：读取

> 当前保存路径由配置决定（默认在 workspace 的 assets/maps 下）。

---

## 12. 已知交互约定（避免踩坑）

- 右键只用于右键菜单，不用于擦除。
- `Space` 用于平移，会抑制其它鼠标工具逻辑。
- `Alt + 左键拖拽` 是“从任意工具进入框选”的入口。
- 粘贴有两种模式：临时（`Ctrl+V` 进入）与锁定（`5` 进入）。
- 图层切换：`PageUp` / `PageDown` 切换当前编辑层；`L` 在 Ground/Upper（第 1/2 层）间快速切换。

右上角图层悬浮控件：
- `显/隐`：切换当前层是否显示
- `解/锁`：切换当前层是否锁定（锁定后任何绘制/填充/粘贴/选区落地都会被阻止）

---

## 13. 下一步候选（待你确认优先级）

以下是紧接着“选区旋转/翻转 + 选区拖拽移动”之后，最像 RM 的增强点：
- 选区拖拽时的“取消（Esc）/吸附（按网格已天然吸附）/数值偏移提示”
- 选区边框 Resize（拖拽边/角调整选区大小）
- 图块笔刷尺寸（2x2/3x3）
- 网格/坐标/HUD 进一步完善
